<% if @recent_updates.any? %>
  <% @recent_updates.each do |update| %>
    <%= turbo_stream.append "updates-list" do %>
      <div class="bg-soft-bone card-pixel p-4 sm:p-6 transform hover:scale-[1.01] transition-transform duration-300" data-controller="modal">
        <div class="flex items-center mb-2 sm:mb-3">
          <% if update.user.avatar.present? %>
            <img src="<%= update.user.avatar %>" alt="<%= update.user.display_name %>" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full mr-2 sm:mr-3">
          <% end %>
          <div>
            <span class="font-medium text-base sm:text-lg 2xl:text-xl"><%= update.user.display_name %></span>
            <span class="text-gray-600 text-xs sm:text-sm 2xl:text-base ml-2"><%= time_ago_in_words(update.created_at) %> ago</span>
            <% if update.timer_sessions.any? %>
              <% timer_session = update.timer_sessions.first %>
              <span class="text-forest text-xs sm:text-sm 2xl:text-base ml-2 block sm:inline">
                <% hours = timer_session.net_time / 3600 %>
                <% minutes = (timer_session.net_time % 3600) / 60 %>
                <% seconds = timer_session.net_time % 60 %>
                <%= image_tag "hourglass.png", class: "w-4 h-4 inline-block" %> Time spent: <%= hours > 0 ? "#{hours}h " : "" %><%= minutes > 0 ? "#{minutes}m " : "" %><%= seconds > 0 ? "#{seconds}s" : "" %>
              </span>
            <% elsif update.last_hackatime_time.present? && update.last_hackatime_time > 0 %>
              <span class="text-forest text-xs sm:text-sm 2xl:text-base ml-2 block sm:inline">
                <% hours = update.last_hackatime_time / 3600 %>
                <% minutes = (update.last_hackatime_time % 3600) / 60 %>
                <% seconds = update.last_hackatime_time % 60 %>
                <%= image_tag "hourglass.png", class: "w-4 h-4 inline-block" %> Time spent: <%= hours > 0 ? "#{hours}h " : "" %><%= minutes > 0 ? "#{minutes}m " : "" %><%= seconds > 0 ? "#{seconds}s" : "" %>
              </span>
            <% end %>
            <span class="text-saddle-taupe text-xs sm:text-sm 2xl:text-base ml-2 block sm:inline">
              <%= image_tag "stonkcoin.png", class: "w-4 h-4 inline-block mr-1", alt: "Stonks" %>
              <%= update.project.stonks.count %> stonkers
            </span>
          </div>
        </div>
        <div class="ml-10 sm:ml-13">
          <h3 class="text-lg sm:text-xl 2xl:text-2xl font-steven mb-2"><%= update.project.title %></h3>
          <div class="prose max-w-none text-gray-600 mb-2 sm:mb-3 text-sm sm:text-base 2xl:text-lg"><%= update.formatted_text %></div>
          <% if update.attachment.present? %>
            <div class="mt-2 sm:mt-3 overflow-hidden rounded-lg">
              <% attachment_url = update.attachment %>
              <% clean_url = attachment_url.gsub(/\?pub_secret=.*$/, '') %>
              <% if clean_url.match?(/\.(jpg|jpeg|png|gif|heic|heif|webp)$/i) %>
                <img src="<%= attachment_url %>" alt="Update attachment" class="w-full h-48 sm:h-64 object-contain cursor-pointer hover:opacity-90 transition-opacity" data-action="click->image-viewer#open">
              <% elsif clean_url.match?(/\.(mp4|webm|mov)$/i) %>
                <div class="h-48 sm:h-64 flex items-center justify-center bg-black">
                  <video src="<%= attachment_url %>" class="w-full h-full object-contain" playsinline controls>
                    Your browser does not support the video tag.
                  </video>
                </div>
              <% elsif update.attachment.match?(/\.(mp3|wav|m4a|ogg|flac)$/i) %>
                <div class="w-full h-48 sm:h-64 flex items-center justify-center">
                  <audio src="<%= update.attachment %>" class="w-[50%]" controls controlsList="nodownload">
                    Your browser does not support the audio tag.
                  </audio>
                </div>
              <% end %>
            </div>
          <% end %>

          <div class="mt-3 sm:mt-4 flex flex-wrap gap-4">
            <%= link_to project_path(update.project), class: "inline-block px-3 sm:px-4 py-1.5 sm:py-2 bg-nice-blue hover:scale-[1.05] text-white transition-transform duration-300 text-base sm:text-lg 2xl:text-xl btn-pixel" do %>
              View Project
            <% end %>

            <% if user_signed_in? %>
              <button data-action="click->modal#open" data-modal-id="<%= update.id %>" data-modal-type="comment" class="inline-block px-3 sm:px-4 py-1.5 sm:py-2 bg-forest hover:scale-[1.05] text-white transition-transform duration-300 text-base sm:text-lg 2xl:text-xl btn-pixel">
                Add Comment
              </button>
            <% end %>
          </div>

          <!-- Comments Section -->
          <% if update.comments.any? %>
            <div class="mt-4 pt-3">
              <h4 class="text-base sm:text-lg font-medium mb-2">Comments (<%= update.comments.count %>)</h4>
              <div class="space-y-3">
                <% update.comments.order(created_at: :asc).first(3).each do |comment| %>
                  <div class="bg-soft-bone border border-saddle-taupe border-opacity-30 p-3">
                    <div class="flex items-center mb-1">
                      <% if comment.user.avatar.present? %>
                        <img src="<%= comment.user.avatar %>" alt="<%= comment.user.display_name %>" class="w-6 h-6 sm:w-7 sm:h-7 rounded-full mr-2">
                      <% end %>
                      <span class="font-medium text-sm sm:text-base"><%= comment.user.display_name %></span>
                      <span class="text-gray-600 text-xs sm:text-sm ml-2"><%= time_ago_in_words(comment.created_at) %> ago</span>
                    </div>
                    <div class="text-gray-700 text-sm sm:text-base">
                      <% if comment.rich_content? %>
                        <%= raw comment.display_content %>
                      <% else %>
                        <%= comment.display_content %>
                      <% end %>
                    </div>
                  </div>
                <% end %>

                <% if update.comments.count > 3 %>
                  <div class="text-center">
                    <%= link_to project_path(update.project), class: "text-nice-blue text-sm sm:text-base hover:underline" do %>
                      See all <%= update.comments.count %> comments
                    <% end %>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
      
      <!-- Comment Modal for this update -->
      <div class="modal hidden fixed inset-0 z-50 overflow-auto bg-black/30 flex items-center justify-center p-2 md:p-4 min-h-screen" id="comment-modal-<%= update.id %>" data-controller="modal comment-modal">
        <div class="bg-soft-bone w-full max-w-2xl card-pixel mx-2 md:mx-auto relative" data-modal-target="container">
          <div class="p-3 md:p-4 border-b border-saddle-taupe border-opacity-30">
            <div class="flex justify-between items-center">
              <h3 class="text-lg md:text-2xl font-steven">Add a Comment</h3>
              <button type="button" class="text-gray-600 hover:text-vintage-red cursor-pointer" data-action="click->modal#close">
                <%= inline_svg_tag "close.svg", class: "h-6 w-6 2xl:h-8 2xl:w-8" %>
              </button>
            </div>
          </div>

          <div class="p-3 md:p-4">
            <% if user_signed_in? %>
              <% if !current_user.has_commented %>
                <div class="text-center mb-4" data-comment-modal-target="warning">
                  <%= image_tag "journeypheus.png", class: "w-32 h-32 2xl:w-64 2xl:h-64 mx-auto mb-4", alt: "Journeypheus" %>
                  <h4 class="text-xl md:text-2xl 2xl:text-3xl font-steven mb-2">HOLD UP</h4>
                  <p class="text-base md:text-lg mb-4 text-gray-600">Be nice in the comments! <a href="https://hackclub.com/conduct/" class="text-nice-blue underline">Hack Club's Code of Conduct</a> still applies here, so don't be naughty, or Journeypheus might just come and kidnap you. <br> (& don't give Kartikey an excuse to ban :P)</p>
                  <button data-action="click->comment-modal#next" class="px-2 md:px-4 py-2 bg-vintage-red hover:scale-[1.05] text-white transition-transform duration-300 text-sm md:text-base 2xl:text-large btn-pixel-sm">
                    Next
                  </button>
                </div>
              <% end %>

              <div class="<%= 'hidden' unless current_user.has_commented %>" data-comment-modal-target="commentForm">
                <%= form_with model: [update, Comment.new],
                    id: "comment-form-#{update.id}",
                    class: "space-y-3",
                    data: {
                      action: "submit->comment-modal#validateForm",
                      controller: "editor",
                      comment_modal_target: "editor"
                    } do |f| %>
                  <div class="space-y-2">
                    <div id="editor-#{update.id}"
                         data-editor-target="editor"
                         class="w-full px-3 py-2 border border-saddle-taupe bg-bread border-opacity-50 focus:outline-none focus:ring-forest focus:border-forest text-sm md:text-base rounded-none">
                    </div>
                    <%= f.hidden_field :rich_content, data: { editor_target: "input" } %>
                    <p class="text-xs md:text-sm text-vintage-red hidden" id="textError-#{update.id}" data-comment-modal-target="textError"></p>
                  </div>

                  <div class="flex flex-row justify-end space-x-4">
                    <button type="button" class="px-2 md:px-4 py-2 bg-vintage-red hover:scale-[1.05] text-white transition-transform duration-300 text-sm md:text-base 2xl:text-large btn-pixel-sm" data-action="click->modal#close">
                      Cancel
                    </button>
                    <%= f.submit "Post Comment", class: "px-2 md:px-4 py-2 bg-forest hover:scale-[1.05] text-white transition-transform duration-300 text-sm md:text-base 2xl:text-large btn-pixel-sm" %>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  <% end %>
<% end %>

<%= turbo_stream.replace "load-more-updates" do %>
  <% if @pagy.next %>
    <%= turbo_frame_tag "load-more-updates", 
          src: explore_path(page: @pagy.next, format: :turbo_stream), 
          loading: "lazy",
          class: "block" do %>
      <div class="flex flex-col items-center justify-center">
          <%= image_tag 'lollipop.svg', class: 'w-8 h-8 sm:w-16 sm:h-16 animate-spin' %>
      </div>
    <% end %>
  <% else %>
    <div id="load-more-updates" class="flex justify-center py-6">
      <div class="text-gray-500 text-sm sm:text-base">
        No more updates to load... Phew you're a doomscroller! Drink water!!
      </div>
    </div>
  <% end %>
<% end %> 
