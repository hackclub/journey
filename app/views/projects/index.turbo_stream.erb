<% if @recent_updates.any? %>
  <% @recent_updates.each do |update| %>
    <%= turbo_stream.append "updates-list" do %>
      <div class="bg-soft-bone card-pixel p-4 sm:p-6 transform hover:scale-[1.01] transition-transform duration-300">
        <div class="flex items-center mb-2 sm:mb-3">
          <% if update.user.avatar.present? %>
            <img src="<%= update.user.avatar %>" alt="<%= update.user.display_name %>" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full mr-2 sm:mr-3">
          <% end %>
          <div>
            <span class="font-medium text-base sm:text-lg 2xl:text-xl"><%= update.user.display_name %></span>
            <span class="text-gray-600 text-xs sm:text-sm 2xl:text-base ml-2"><%= time_ago_in_words(update.created_at) %> ago</span>
          </div>
        </div>
        <div class="ml-10 sm:ml-13">
          <h3 class="text-lg sm:text-xl 2xl:text-2xl font-steven mb-2"><%= update.project.title %></h3>
          <div class="prose max-w-none text-gray-600 mb-2 sm:mb-3 text-sm sm:text-base 2xl:text-lg"><%= update.formatted_text %></div>
          <% if update.attachment.present? %>
            <div class="mt-2 sm:mt-3 overflow-hidden rounded-lg">
              <% attachment_url = update.attachment %>
              <% clean_url = attachment_url.gsub(/\?pub_secret=.*$/, '') %>
              <% if clean_url.match?(/\.(jpg|jpeg|png|gif)$/i) %>
                <img src="<%= attachment_url %>" alt="Update attachment" class="w-full h-48 sm:h-64 object-contain cursor-pointer hover:opacity-90 transition-opacity" data-action="click->image-viewer#open">
              <% elsif clean_url.match?(/\.(mp4|webm|mov)$/i) %>
                <div class="h-48 sm:h-64 flex items-center justify-center bg-black">
                  <video src="<%= attachment_url %>" class="w-full h-full object-contain" playsinline controls>
                    Your browser does not support the video tag.
                  </video>
                </div>
              <% elsif update.attachment.match?(/\.(mp3|wavmak)$/i) %>
                <div class="w-full h-48 sm:h-64 flex items-center justify-center">
                  <audio src="<%= update.attachment %>" class="w-[50%]" controls controlsList="nodownload">
                    Your browser does not support the audio tag.
                  </audio>
                </div>
              <% end %>
            </div>
          <% end %>

          <div class="mt-3 sm:mt-4 flex flex-wrap gap-4">
            <%= link_to project_path(update.project), class: "inline-block px-3 sm:px-4 py-1.5 sm:py-2 bg-nice-blue hover:scale-[1.05] text-white transition-transform duration-300 text-base sm:text-lg 2xl:text-xl btn-pixel" do %>
              View Project
            <% end %>

            <% if user_signed_in? %>
              <button data-action="click->modal#open" data-modal-id="<%= update.id %>" data-modal-type="comment" class="inline-block px-3 sm:px-4 py-1.5 sm:py-2 bg-forest hover:scale-[1.05] text-white transition-transform duration-300 text-base sm:text-lg 2xl:text-xl btn-pixel">
                Add Comment
              </button>
            <% end %>
          </div>

          <!-- Comments Section -->
          <% if update.comments.any? %>
            <div class="mt-4 border-t border-saddle-taupe border-opacity-30 pt-3">
              <h4 class="text-base sm:text-lg font-medium mb-2">Comments (<%= update.comments.count %>)</h4>
              <div class="space-y-3">
                <% update.comments.order(created_at: :asc).first(3).each do |comment| %>
                  <div class="bg-soft-bone border border-saddle-taupe border-opacity-30 p-3">
                    <div class="flex items-center mb-1">
                      <% if comment.user.avatar.present? %>
                        <img src="<%= comment.user.avatar %>" alt="<%= comment.user.display_name %>" class="w-6 h-6 sm:w-7 sm:h-7 rounded-full mr-2">
                      <% end %>
                      <span class="font-medium text-sm sm:text-base"><%= comment.user.display_name %></span>
                      <span class="text-gray-600 text-xs sm:text-sm ml-2"><%= time_ago_in_words(comment.created_at) %> ago</span>
                    </div>
                    <div class="text-gray-700 text-sm sm:text-base"><%= comment.text %></div>
                  </div>
                <% end %>

                <% if update.comments.count > 3 %>
                  <div class="text-center">
                    <%= link_to project_path(update.project), class: "text-nice-blue text-sm sm:text-base hover:underline" do %>
                      See all <%= update.comments.count %> comments
                    <% end %>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  <% end %>
<% end %>

<%= turbo_stream.replace "load-more-updates" do %>
  <% if @pagy.next %>
    <%= turbo_frame_tag "load-more-updates", 
          src: explore_path(page: @pagy.next, format: :turbo_stream), 
          loading: "lazy",
          class: "block" do %>
      <div class="flex flex-col items-center justify-center">
          <%= image_tag 'lollipop.svg', class: 'w-8 h-8 sm:w-16 sm:h-16 animate-spin' %>
      </div>
    <% end %>
  <% else %>
    <div id="load-more-updates" class="flex justify-center py-6">
      <div class="text-gray-500 text-sm sm:text-base">
        No more updates to load... Phew you're a doomscroller! Drink water!!
      </div>
    </div>
  <% end %>
<% end %> 