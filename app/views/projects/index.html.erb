<div data-controller="modal">
  <div data-controller="project-loader">
    <!-- Loading State -->
    <div data-project-loader-target="loadingIndicator" class="flex items-center justify-center py-6 sm:py-12">
      <div class="flex flex-col items-center justify-center">
          <%= image_tag 'lollipop.svg', class: 'w-16 h-16 sm:w-24 sm:h-24 animate-spin' %>
      </div>
    </div>

    <div class="flex flex-col justify-between items-start mb-4 md:mb-6 px-4 md:px-8 pt-2 md:pt-8 pb-2 hidden" data-project-loader-target="title">
      <div class="flex justify-between items-center w-full flex-wrap">
        <h1 class="text-4xl sm:text-5xl font-steven mb-0"><%= params[:action] == 'my_projects' ? 'My Projects' : 'Explore' %></h1>
        <% if user_signed_in? && params[:action] == 'my_projects' %>
          <% if current_user.has_hackatime %>
            <button data-controller="modal" data-action="click->modal#open" data-modal-type="hackatime" class="px-4 py-2 btn-pixel bg-nice-blue text-white hover:scale-[1.05] transition-transform text-base md:text-lg mt-2 md:mt-0">
              Manually Sync Hackatime
            </button>
          <% else %>
            <button data-controller="modal" data-action="click->modal#open" data-modal-type="hackatime" class="px-4 py-2 btn-pixel bg-vintage-red text-white hover:scale-[1.05] transition-transform text-base md:text-lg mt-2 md:mt-0">
              Connect Hackatime
            </button>
          <% end %>
        <% end %>
      </div>
    </div>

    <div class="hidden" data-project-loader-target="content">
      <% if params[:action] == 'my_projects' %>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 2xl:grid-cols-4 gap-4 md:gap-8 px-4 md:px-8">
          <% if @projects.any? %>
            <% @projects.each do |project| %>
              <div class="bg-soft-bone card-pixel transform hover:scale-[1.02] transition-transform duration-300 flex flex-col h-full">
                <% project_image = project.banner.presence || project.updates.find { |u| u.attachment.present? }&.attachment || "https://raw.githubusercontent.com/hackclub/dinosaurs/main/confused_dinosaur.png" %>
                <div class="h-36 md:h-48 overflow-hidden relative">
                  <img src="<%= project_image %>" alt="<%= project.title %>" class="w-full h-full object-cover">
                </div>

                <div class="p-4 md:p-6 flex flex-col flex-grow">
                  <div class="flex items-center justify-between mb-2 md:mb-3">
                    <h2 class="text-xl md:text-2xl 2xl:text-3xl font-steven line-clamp-1"><%= project.title %></h2>
                    <% if user_signed_in? && current_user != project.user %>
                      <div>
                        <%= render "projects/follow_button", project: project %>
                      </div>
                    <% end %>
                  </div>
                  <p class="mb-4 md:mb-6 line-clamp-3 text-sm md:text-base 2xl:text-lg text-gray-600"><%= project.description %></p>

                  <div class="flex flex-row space-x-4 mt-auto flex-wrap">
                    <%= link_to project_path(project), class: "px-3 md:px-4 py-2 bg-forest hover:scale-[1.05] text-white transition-transform duration-300 flex-1 text-center btn-pixel text-base md:text-lg 2xl:text-2xl" do %>
                      View Project
                    <% end %>
                    <%= link_to project_path(project), class: "px-3 md:px-4 py-2 bg-nice-blue text-white hover:scale-[1.05] transition-transform duration-300 flex-1 text-center btn-pixel text-base md:text-lg 2xl:text-xl" do %>
                      <%= project.updates.count %> Updates
                    <% end %>
                  </div>
                </div>
              </div>
            <% end %>

            <div class="bg-soft-bone card-pixel transform hover:scale-[1.02] transition-transform duration-300 flex flex-col h-full items-center justify-center p-6">
              <button data-action="click->modal#open" data-modal-type="create-project" class="px-6 md:px-8 py-3 bg-forest hover:scale-[1.05] text-white transition-transform duration-300 text-center btn-pixel text-lg md:text-xl 2xl:text-2xl">
                Create Project
              </button>
            </div>
          <% else %>
            <div class="col-span-full flex flex-col items-center justify-center bg-soft-bone p-6 md:p-8 card-pixel mt-2 md:mt-0">
              <div class="flex justify-center items-center">
                <%= image_tag 'happytriangle.png', class: 'w-32 h-32 sm:w-48 sm:h-48 2xl:w-64 2xl:h-64 transform scale-x-[-1] mb-4 sm:mb-6' %>
              </div>
              <p class="mb-6 sm:mb-8 text-black text-large sm:text-xl 2xl:text-2xl text-center">You don't have a project yet. Create one to start your journey!</p>
              <button data-action="click->modal#open" data-modal-type="create-project" class="px-4 md:px-6 py-1 md:py-2 bg-forest hover:bg-forest-dark text-white text-base md:text-lg 2xl:text-xl btn-pixel cursor-pointer">
                Create Your Project
              </button>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="px-4 md:px-8">
          <div class="space-y-4 sm:space-y-6" id="updates-list">
            <% if @recent_updates && @recent_updates.any? %>
              <% @recent_updates.each do |update| %>
                <div class="bg-soft-bone card-pixel p-4 sm:p-6 transform hover:scale-[1.01] transition-transform duration-300">
                  <div class="flex items-center mb-2 sm:mb-3">
                    <% if update.user.avatar.present? %>
                      <img src="<%= update.user.avatar %>" alt="<%= update.user.display_name %>" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full mr-2 sm:mr-3">
                    <% end %>
                    <div>
                      <span class="font-medium text-base sm:text-lg 2xl:text-xl"><%= update.user.display_name %></span>
                      <span class="text-gray-600 text-xs sm:text-sm 2xl:text-base ml-2"><%= time_ago_in_words(update.created_at) %> ago</span>
                    </div>
                  </div>
                  <div class="ml-10 sm:ml-13">
                    <h3 class="text-lg sm:text-xl 2xl:text-2xl font-steven mb-2"><%= update.project.title %></h3>
                    <div class="prose max-w-none text-gray-600 mb-2 sm:mb-3 text-sm sm:text-base 2xl:text-lg"><%= update.formatted_text %></div>
                    <% if update.attachment.present? %>
                      <div class="mt-2 sm:mt-3 overflow-hidden rounded-lg">
                        <% attachment_url = update.attachment %>
                        <% clean_url = attachment_url.gsub(/\?pub_secret=.*$/, '') %>
                        <% if clean_url.match?(/\.(jpg|jpeg|png|gif)$/i) %>
                          <img src="<%= attachment_url %>" alt="Update attachment" class="w-full h-48 sm:h-64 object-contain cursor-pointer hover:opacity-90 transition-opacity" data-action="click->image-viewer#open">
                        <% elsif clean_url.match?(/\.(mp4|webm|mov)$/i) %>
                          <div class="h-48 sm:h-64 flex items-center justify-center bg-black">
                            <video src="<%= attachment_url %>" class="w-full h-full object-contain" playsinline controls>
                              Your browser does not support the video tag.
                            </video>
                          </div>
                        <% elsif update.attachment.match?(/\.(mp3|wavmak)$/i) %>
                          <div class="w-full h-48 sm:h-64 flex items-center justify-center">
                            <audio src="<%= update.attachment %>" class="w-[50%]" controls controlsList="nodownload">
                              Your browser does not support the audio tag.
                            </audio>
                          </div>
                        <% end %>
                      </div>
                    <% end %>

                    <div class="mt-3 sm:mt-4 flex flex-wrap gap-4">
                      <%= link_to project_path(update.project), class: "inline-block px-3 sm:px-4 py-1.5 sm:py-2 bg-nice-blue hover:scale-[1.05] text-white transition-transform duration-300 text-base sm:text-lg 2xl:text-xl btn-pixel" do %>
                        View Project
                      <% end %>

                      <% if user_signed_in? %>
                        <button data-action="click->modal#open" data-modal-id="<%= update.id %>" data-modal-type="comment" class="inline-block px-3 sm:px-4 py-1.5 sm:py-2 bg-forest hover:scale-[1.05] text-white transition-transform duration-300 text-base sm:text-lg 2xl:text-xl btn-pixel">
                          Add Comment
                        </button>
                      <% end %>
                    </div>

                    <!-- Comments Section -->
                    <% if update.comments.any? %>
                      <div class="mt-4 border-t border-saddle-taupe border-opacity-30 pt-3">
                        <h4 class="text-base sm:text-lg font-medium mb-2">Comments (<%= update.comments.count %>)</h4>
                        <div class="space-y-3">
                          <% update.comments.order(created_at: :asc).first(3).each do |comment| %>
                            <div class="bg-soft-bone border border-saddle-taupe border-opacity-30 p-3">
                              <div class="flex items-center mb-1">
                                <% if comment.user.avatar.present? %>
                                  <img src="<%= comment.user.avatar %>" alt="<%= comment.user.display_name %>" class="w-6 h-6 sm:w-7 sm:h-7 rounded-full mr-2">
                                <% end %>
                                <span class="font-medium text-sm sm:text-base"><%= comment.user.display_name %></span>
                                <span class="text-gray-600 text-xs sm:text-sm ml-2"><%= time_ago_in_words(comment.created_at) %> ago</span>
                              </div>
                              <div class="text-gray-700 text-sm sm:text-base"><%= comment.text %></div>
                            </div>
                          <% end %>

                          <% if update.comments.count > 3 %>
                            <div class="text-center">
                              <%= link_to project_path(update.project), class: "text-nice-blue text-sm sm:text-base hover:underline" do %>
                                See all <%= update.comments.count %> comments
                              <% end %>
                            </div>
                          <% end %>
                        </div>
                      </div>
                    <% end %>
                  </div>
                </div>
              <% end %>
            <% else %>
              <div class="bg-soft-bone card-pixel p-6 flex flex-col items-center justify-center py-6">
                <div class="flex justify-center items-center">
                  <%= image_tag 'puppyeyes.png', class: 'w-32 h-32 sm:w-48 sm:h-48 2xl:w-64 2xl:h-64 transform scale-x-[-1] mb-4 sm:mb-6' %>
                </div>
                <p class="mb-6 sm:mb-8 text-black text-large sm:text-xl 2xl:text-2xl text-center">No updates available. Check back later for new project updates.</p>
                <button data-action="click->modal#open" data-modal-type="create-project" class="px-4 md:px-6 py-1 md:py-2 bg-forest hover:bg-forest-dark text-white text-base md:text-lg 2xl:text-xl btn-pixel cursor-pointer">
                  Create Your Project
                </button>
              </div>
            <% end %>
          </div>

          <!-- Dear Lord Pagy life saver, but it is infitnie scroll trigger -->
          <% if @pagy && @pagy.next %>
            <%= turbo_frame_tag "load-more-updates",
                  src: explore_path(page: @pagy.next, format: :turbo_stream),
                  loading: "lazy",
                  class: "block" do %>
              <div class="flex flex-col items-center justify-center">
                  <%= image_tag 'lollipop.svg', class: 'w-8 h-8 sm:w-16 sm:h-16 animate-spin' %>
              </div>
            <% end %>
          <% elsif @recent_updates && @recent_updates.any? %>
            <div class="flex justify-center py-6">
              <div class="text-gray-500 text-sm sm:text-base">
                No more updates to load... Phew you're a doomscroller! Drink water!!
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>

  <div id="create-project-modal" data-controller="modal" class="hidden fixed inset-0 z-50 overflow-auto bg-black/30 flex items-center justify-center p-2 md:p-4">
    <div class="bg-soft-bone w-full max-w-2xl card-pixel mx-2 md:mx-auto relative" data-modal-target="container">
      <div class="p-3 md:p-6 border-b border-saddle-taupe border-opacity-30">
        <div class="flex justify-between items-center">
          <h3 class="text-lg md:text-2xl font-steven">Create New Project</h3>
          <button type="button" class="text-gray-600 hover:text-vintage-red cursor-pointer" data-action="click->modal#close">
            <%= inline_svg_tag "close.svg", class: "h-6 w-6 2xl:h-8 2xl:w-8" %>
          </button>
        </div>
      </div>

      <div class="max-h-[calc(90vh-100px)] overflow-y-auto overflow-x-hidden">
        <%= form_with model: Project.new, class: "p-3 md:p-6 mx-auto w-[calc(100%-2px)]", data: { controller: "project-form", action: "submit->project-form#validateForm" } do |f| %>
          <div class="space-y-2 md:space-y-4">
            <div class="mb-2 md:mb-4">
              <%= f.label :title, class: "block text-sm font-medium mb-1" %>
              <%= f.text_field :title, class: "w-full px-3 py-2 border border-saddle-taupe bg-bread border-opacity-50 focus:outline-none focus:ring-forest focus:border-forest text-sm md:text-base", id: "title", data: { project_form_target: "title" } %>
              <div class="flex justify-end">
                <p class="mt-1 text-xs md:text-sm text-vintage-red">Required</p>
              </div>
              <p class="mt-1 text-xs md:text-sm text-vintage-red hidden" id="titleError" data-project-form-target="titleError"></p>
            </div>

            <div class="mb-2 md:mb-4">
              <%= f.label :description, class: "block text-sm font-medium mb-1" %>
              <%= f.text_area :description, rows: 3, class: "w-full px-3 py-2 border border-saddle-taupe bg-bread border-opacity-50 focus:outline-none focus:ring-forest focus:border-forest text-sm md:text-base", id: "description", data: { project_form_target: "description" } %>
              <div class="flex justify-end">
                <p class="mt-1 text-xs md:text-sm text-vintage-red">Required</p>
              </div>
              <p class="mt-1 text-xs md:text-sm text-vintage-red hidden" id="descriptionError" data-project-form-target="descriptionError"></p>
            </div>

            <div class="mb-2 md:mb-4">
              <%= f.label :category, class: "block text-sm font-medium mb-1" %>
              <div class="relative">
                <%= f.select :category,
                    [["Select a category", ""], "Software", "Hardware", "Both Software & Hardware", "Something else"],
                    {},
                    class: "w-full px-3 py-2 border border-saddle-taupe bg-bread border-opacity-50 focus:outline-none focus:ring-forest focus:border-forest text-sm md:text-base appearance-none pr-10",
                    id: "category",
                    data: { project_form_target: "category" } %>
                <div class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                  <%= inline_svg "chevron-down.svg", class: "h-5 w-5 text-gray-600" %>
                </div>
              </div>
              <div class="flex justify-end">
                <p class="mt-1 text-xs md:text-sm text-vintage-red">Required. You cannot change this later.</p>
              </div>
              <p class="mt-1 text-xs md:text-sm text-vintage-red hidden" id="categoryError" data-project-form-target="categoryError"></p>
            </div>

            <div class="mb-2 md:mb-4">
              <%= f.label :banner, "Project Banner", class: "block text-sm font-medium mb-1" %>
              <%= f.url_field :banner, placeholder: "https://journey.hackclub.com/banner.png", class: "w-full px-3 py-2 border border-saddle-taupe bg-bread border-opacity-50 focus:outline-none focus:ring-forest focus:border-forest text-sm md:text-base", id: "banner", data: { project_form_target: "banner" } %>
              <div class="flex justify-end">
                <p class="mt-1 text-xs md:text-sm text-gray-700">Optional</p>
              </div>
              <p class="mt-1 text-xs md:text-sm text-vintage-red hidden" id="bannerError" data-project-form-target="bannerError"></p>
            </div>

            <div class="mb-2 md:mb-4">
              <%= f.label :readme_link, "Readme Link", class: "block text-sm font-medium mb-1" %>
              <%= f.url_field :readme_link, placeholder: "https://github.com/hackclub/journey/README.md", class: "w-full px-3 py-2 border border-saddle-taupe bg-bread border-opacity-50 focus:outline-none focus:ring-forest focus:border-forest text-sm md:text-base", id: "readme", data: { project_form_target: "readme" } %>
              <div class="flex justify-end">
                <p class="mt-1 text-xs md:text-sm text-gray-700">Optional</p>
              </div>
              <p class="mt-1 text-xs md:text-sm text-vintage-red hidden" id="readmeError" data-project-form-target="readmeError"></p>
            </div>

            <div class="mb-2 md:mb-4">
              <%= f.label :demo_link, "Demo Link", class: "block text-sm font-medium mb-1" %>
              <%= f.url_field :demo_link, placeholder: "https://journey.hackclub.com", class: "w-full px-3 py-2 border border-saddle-taupe bg-bread border-opacity-50 focus:outline-none focus:ring-forest focus:border-forest text-sm md:text-base", id: "demo", data: { project_form_target: "demo" } %>
              <div class="flex justify-end">
                <p class="mt-1 text-xs md:text-sm text-gray-700">Optional</p>
              </div>
              <p class="mt-1 text-xs md:text-sm text-vintage-red hidden" id="demoError" data-project-form-target="demoError"></p>
            </div>

            <div class="mb-3 md:mb-6">
              <%= f.label :repo_link, "Repository Link", class: "block text-sm font-medium mb-1" %>
              <%= f.url_field :repo_link, placeholder: "https://github.com/hackclub/journey", class: "w-full px-3 py-2 border border-saddle-taupe bg-bread border-opacity-50 focus:outline-none focus:ring-forest focus:border-forest text-sm md:text-base", id: "repo", data: { project_form_target: "repo" } %>
              <div class="flex justify-end">
                <p class="mt-1 text-xs md:text-sm text-gray-700">Optional</p>
              </div>
              <p class="mt-1 text-xs md:text-sm text-vintage-red hidden" id="repoError" data-project-form-target="repoError"></p>
            </div>

            <% if current_user&.has_hackatime %>
              <div class="mb-3 md:mb-6 border-t border-saddle-taupe border-opacity-30 pt-3">
                <div class="flex items-center mb-2">
                  <h4 class="text-base md:text-lg font-steven">Link HackaTime Projects</h4>
                </div>

                <div id="hackatime-projects" data-project-form-target="hackatimeProjects" class="space-y-2">
                  <% hackatime_projects = current_user.hackatime_projects %>
                  <% if hackatime_projects.present? %>
                    <div class="hackatime-project-field mb-2">
                      <select name="__temp_hackatime_select" class="w-full px-3 py-2 border border-saddle-taupe bg-bread border-opacity-50 focus:outline-none focus:ring-forest focus:border-forest text-sm md:text-base" data-project-form-target="hackatimeSelect">
                        <option value="">Select a project...</option>
                        <% hackatime_projects.each do |project| %>
                          <option value="<%= project[:key] %>">
                            <%= project[:name] %> (<%= project[:formatted_time] %>)
                          </option>
                        <% end %>
                      </select>
                    </div>

                    <div class="selected-hackatime-projects space-y-2" data-project-form-target="selectedProjects">
                    </div>

                  <% else %>
                    <div class="p-3 rounded">
                      <p class="text-sm text-gray-700">
                        No HackaTime projects found. Make sure your HackaTime account is connected and has projects.
                      </p>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>

            <p class="text-xs md:text-base text-gray-800 border-t border-saddle-taupe border-opacity-30 pt-3">
              Only Title, Description, and Category are required. All other fields can be added later when you're ready to ship.
            </p>
          </div>

          <div class="flex flex-row justify-end space-x-2 md:space-x-3 mt-3 md:mt-4">
            <button type="button" data-action="modal#close" class="px-3 md:px-4 py-1 md:py-2 bg-vintage-red text-white hover:scale-[1.05] btn-pixel-sm text-sm md:text-base">
              Cancel
            </button>
            <%= f.submit "Create Project", class: "px-3 md:px-4 py-1 md:py-2 bg-forest text-white hover:scale-[1.05] btn-pixel-sm text-sm md:text-base" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Comment Modals for Updates -->
  <% if @recent_updates && @recent_updates.any? && user_signed_in? %>
    <% @recent_updates.each do |update| %>
      <div class="modal hidden fixed inset-0 z-50 overflow-auto bg-black/30 flex items-center justify-center p-2 md:p-4 min-h-screen" id="comment-modal-<%= update.id %>" data-controller="modal comment-modal">
        <div class="bg-soft-bone w-full max-w-2xl card-pixel mx-2 md:mx-auto relative" data-modal-target="container">
          <div class="p-3 md:p-4 border-b border-saddle-taupe border-opacity-30">
            <div class="flex justify-between items-center">
              <h3 class="text-lg md:text-2xl font-steven">Add a Comment</h3>
              <button type="button" class="text-gray-600 hover:text-vintage-red cursor-pointer" data-action="click->modal#close">
                <%= inline_svg_tag "close.svg", class: "h-6 w-6 2xl:h-8 2xl:w-8" %>
              </button>
            </div>
          </div>

          <div class="p-3 md:p-4">
            <% if !current_user.has_commented %>
              <div class="text-center mb-4" data-comment-modal-target="warning">
                <%= image_tag "journeypheus.png", class: "w-32 h-32 2xl:w-64 2xl:h-64 mx-auto mb-4", alt: "Journeypheus" %>
                <h4 class="text-xl md:text-2xl 2xl:text-3xl font-steven mb-2">HOLD UP</h4>
                <p class="text-base md:text-lg mb-4 text-gray-600">Be nice in the comments! <a href="https://hackclub.com/conduct/" class="text-nice-blue underline">Hack Club's Code of Conduct</a> still applies here, so don't be naughty, or Journeypheus might just come and kidnap you. <br> (& don't give Kartikey an excuse to ban :P)</p>
                <button data-action="click->comment-modal#next" class="px-2 md:px-4 py-2 bg-vintage-red hover:scale-[1.05] text-white transition-transform duration-300 text-sm md:text-base 2xl:text-large btn-pixel-sm">
                  Next
                </button>
              </div>
            <% end %>

            <div class="<%= 'hidden' unless current_user.has_commented %>" data-comment-modal-target="commentForm">
              <%= form_with model: [update, Comment.new],
                  id: "comment-form-#{update.id}",
                  class: "space-y-3",
                  data: {
                    action: "submit->comment-modal#validateForm"
                  } do |f| %>
                <div class="space-y-2">
                  <%= f.text_area :text,
                      id: "text-#{update.id}",
                      class: "w-full px-3 py-2 border border-saddle-taupe bg-bread border-opacity-50 focus:outline-none focus:ring-forest focus:border-forest text-sm md:text-base rounded-none",
                      rows: 4,
                      placeholder: "Write your comment here... (be nice)",
                      data: { comment_modal_target: "text" } %>
                  <p class="text-xs md:text-sm text-vintage-red hidden" id="textError-#{update.id}" data-comment-modal-target="textError"></p>

                <div class="flex flex-row justify-end space-x-4">
                  <button type="button" class="px-2 md:px-4 py-2 bg-vintage-red hover:scale-[1.05] text-white transition-transform duration-300 text-sm md:text-base 2xl:text-large btn-pixel-sm" data-action="click->modal#close">
                    Cancel
                  </button>
                  <%= f.submit "Post Comment", class: "px-2 md:px-4 py-2 bg-forest hover:scale-[1.05] text-white transition-transform duration-300 text-sm md:text-base 2xl:text-large btn-pixel-sm" %>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  <% end %>
</div>
